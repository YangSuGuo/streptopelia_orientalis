# 数据库操作完整流程示例

## 场景1：上班打卡流程（出门→上班→下班→到家）

### 1. 创建分类
```sql
INSERT INTO categories (name, description, color, icon, sort_order) 
VALUES ('上班打卡', '记录上下班打卡信息', '#FF6B6B', 'work', 1);
```
**结果:** 返回 `category_id = 1`

| id   | name     | description        | color   | icon | sort_order | created_at          | updated_at          |
| ---- | -------- | ------------------ | ------- | ---- | ---------- | ------------------- | ------------------- |
| 1    | 上班打卡 | 记录上下班打卡信息 | #FF6B6B | work | 1          | 2026-01-08 08:00:00 | 2026-01-08 08:00:00 |

### 2. 创建记录类型
```sql
INSERT INTO record_types (
    name, category_id, description, require_location, has_timer, has_subtasks, 
    has_numeric_values, selection_options, require_photo, max_photos
) VALUES (
    '上班打卡', 1, '记录上下班打卡流程', 1, 1, 1, 0, 
    '{"steps": ["出门", "上班", "下班", "到家"]}', 1, 4
);
```
**结果:** 返回 `record_type_id = 1`

| id   | name     | category_id | description        | require_location | has_timer | has_subtasks | has_numeric_values | selection_options                           | require_photo | max_photos | created_at          | updated_at          |
| ---- | -------- | ----------- | ------------------ | ---------------- | --------- | ------------ | ------------------ | ------------------------------------------- | ------------- | ---------- | ------------------- | ------------------- |
| 1    | 上班打卡 | 1           | 记录上下班打卡流程 | 1                | 1         | 1            | 0                  | {"steps": ["出门", "上班", "下班", "到家"]} | 1             | 4          | 2026-01-08 08:00:00 | 2026-01-08 08:00:00 |

### 3. 创建分步配置
```sql
INSERT INTO record_step_configs (record_type_id, step_name, step_description, step_order, required, allow_skip) VALUES 
(1, '出门', '离开家', 1, 1, 0),
(1, '上班', '到达公司', 2, 1, 0),
(1, '下班', '离开公司', 3, 1, 0),
(1, '到家', '回到家里', 4, 1, 0);
```
**结果:** 创建4条分步配置记录

| id   | record_type_id | step_name | step_description | step_order | required | allow_skip | created_at          |
| ---- | -------------- | --------- | ---------------- | ---------- | -------- | ---------- | ------------------- |
| 1    | 1              | 出门      | 离开家           | 1          | 1        | 0          | 2026-01-08 08:00:00 |
| 2    | 1              | 上班      | 到达公司         | 2          | 1        | 0          | 2026-01-08 08:00:00 |
| 3    | 1              | 下班      | 离开公司         | 3          | 1        | 0          | 2026-01-08 08:00:00 |
| 4    | 1              | 到家      | 回到家里         | 4          | 1        | 0          | 2026-01-08 08:00:00 |

### 4. 创建主记录
```sql
INSERT INTO records (
    record_type_id, title, start_time, end_time, duration_seconds, 
    location_name, latitude, longitude, status
) VALUES (
    1, '2026年1月8日上班', 
    '2026-01-08 08:00:00', '2026-01-08 18:30:00', 37800,
    '公司办公室', 39.9042, 116.4074, 'completed'
);
```
**结果:** 返回 `record_id = 1`

| id   | record_type_id | title            | start_time          | end_time            | duration_seconds | location_name | latitude | longitude | status    | created_at          |
| ---- | -------------- | ---------------- | ------------------- | ------------------- | ---------------- | ------------- | -------- | --------- | --------- | ------------------- |
| 1    | 1              | 2026年1月8日上班 | 2026-01-08 08:00:00 | 2026-01-08 18:30:00 | 37800            | 公司办公室    | 39.9042  | 116.4074  | completed | 2026-01-08 08:00:00 |

### 5. 创建分步记录
```sql
INSERT INTO record_steps (record_id, step_name, step_order, step_status, completed_at) VALUES 
(1, '出门', 1, 'completed', '2026-01-08 08:00:00'),
(1, '上班', 2, 'completed', '2026-01-08 08:30:00'),
(1, '下班', 3, 'completed', '2026-01-08 18:00:00'),
(1, '到家', 4, 'completed', '2026-01-08 18:30:00');
```
**结果:** 创建4条分步记录

| id   | record_id | step_name | step_order | step_status | completed_at        | created_at          |
| ---- | --------- | --------- | ---------- | ----------- | ------------------- | ------------------- |
| 1    | 1         | 出门      | 1          | completed   | 2026-01-08 08:00:00 | 2026-01-08 08:00:00 |
| 2    | 1         | 上班      | 2          | completed   | 2026-01-08 08:30:00 | 2026-01-08 08:00:00 |
| 3    | 1         | 下班      | 3          | completed   | 2026-01-08 18:00:00 | 2026-01-08 08:00:00 |
| 4    | 1         | 到家      | 4          | completed   | 2026-01-08 18:30:00 | 2026-01-08 08:00:00 |

### 6. 创建照片记录
```sql
INSERT INTO record_photos (record_id, photo_path, description, sort_order) VALUES 
(1, '/storage/photos/checkin_20260108_0830.jpg', '上班打卡照片', 1),
(1, '/storage/photos/checkout_20260108_1800.jpg', '下班打卡照片', 2);
```
**结果:** 创建2张照片记录

| id   | record_id | photo_path                                 | description  | sort_order | created_at          |
| ---- | --------- | ------------------------------------------ | ------------ | ---------- | ------------------- |
| 1    | 1         | /storage/photos/checkin_20260108_0830.jpg  | 上班打卡照片 | 1          | 2026-01-08 08:00:00 |
| 2    | 1         | /storage/photos/checkout_20260108_1800.jpg | 下班打卡照片 | 2          | 2026-01-08 08:00:00 |

### 7. 创建位置记录
```sql
INSERT INTO record_locations (record_id, latitude, longitude, address, location_name, accuracy) VALUES 
(1, 39.9042, 116.4074, '北京市朝阳区某某大厦', '公司办公室', 10.0),
(1, 39.9152, 116.4044, '北京市朝阳区某某小区', '家', 10.0);
```
**结果:** 创建2个位置记录

| id   | record_id | latitude | longitude | address              | location_name | accuracy | created_at          |
| ---- | --------- | -------- | --------- | -------------------- | ------------- | -------- | ------------------- |
| 1    | 1         | 39.9042  | 116.4074  | 北京市朝阳区某某大厦 | 公司办公室    | 10.0     | 2026-01-08 08:00:00 |
| 2    | 1         | 39.9152  | 116.4044  | 北京市朝阳区某某小区 | 家            | 10.0     | 2026-01-08 08:00:00 |

### 8. 创建标签记录
```sql
INSERT INTO record_tags (record_id, tag_name, tag_color) VALUES 
(1, '上班', '#FF6B6B'),
(1, '打卡', '#4ECDC4');
```
**结果:** 创建2个标签记录

| id   | record_id | tag_name | tag_color | created_at          |
| ---- | --------- | -------- | --------- | ------------------- |
| 1    | 1         | 上班     | #FF6B6B   | 2026-01-08 08:00:00 |
| 2    | 1         | 打卡     | #4ECDC4   | 2026-01-08 08:00:00 |

### 9. 创建分类记录关联
```sql
INSERT INTO category_records (category_id, record_id) VALUES (1, 1);
```
**结果:** 创建分类与记录的关联

| id   | category_id | record_id | created_at          |
| ---- | ----------- | --------- | ------------------- |
| 1    | 1           | 1         | 2026-01-08 08:00:00 |

### 10. 查询完整记录
```sql
SELECT 
    r.id as record_id,
    r.title,
    r.start_time,
    r.end_time,
    r.duration_seconds,
    rt.name as record_type_name,
    c.name as category_name,
    GROUP_CONCAT(rs.step_name || '(' || rs.step_status || ')', ', ') as steps,
    COUNT(rp.id) as photo_count,
    COUNT(rl.id) as location_count,
    GROUP_CONCAT(rt.tag_name, ', ') as tags
FROM records r
JOIN record_types rt ON r.record_type_id = rt.id
JOIN categories c ON rt.category_id = c.id
LEFT JOIN record_steps rs ON r.id = rs.record_id
LEFT JOIN record_photos rp ON r.id = rp.record_id
LEFT JOIN record_locations rl ON r.id = rl.record_id
LEFT JOIN record_tags rt ON r.id = rt.record_id
WHERE r.id = 1
GROUP BY r.id;
```
**查询结果:**
| record_id | title            | start_time          | end_time            | duration_seconds | record_type_name | category_name | steps                                                        | photo_count | location_count | tags       |
| --------- | ---------------- | ------------------- | ------------------- | ---------------- | ---------------- | ------------- | ------------------------------------------------------------ | ----------- | -------------- | ---------- |
| 1         | 2026年1月8日上班 | 2026-01-08 08:00:00 | 2026-01-08 18:30:00 | 37800            | 上班打卡         | 上班打卡      | 出门(completed), 上班(completed), 下班(completed), 到家(completed) | 2           | 2              | 上班, 打卡 |

### 11. 更新记录状态
```sql
UPDATE records SET status = 'archived' WHERE id = 1;
```
**结果:** 记录状态变为 'archived'

| id   | record_type_id | title            | start_time          | end_time            | duration_seconds | location_name | latitude | longitude | status   | created_at          |
| ---- | -------------- | ---------------- | ------------------- | ------------------- | ---------------- | ------------- | -------- | --------- | -------- | ------------------- |
| 1    | 1              | 2026年1月8日上班 | 2026-01-08 08:00:00 | 2026-01-08 18:30:00 | 37800            | 公司办公室    | 39.9042  | 116.4074  | archived | 2026-01-08 08:00:00 |

### 12. 删除记录（级联删除相关数据）
```sql
DELETE FROM records WHERE id = 1;
```
**结果:**
- 删除记录ID=1
- 自动删除相关的分步记录、照片记录、位置记录、标签记录（外键约束 ON DELETE CASCADE）

---

## 场景2：个人支出记录流程

### 1. 创建记录类型
```sql
INSERT INTO record_types (
    name, category_id, description, has_numeric_values, has_text_values,
    selection_options, require_photo, max_photos
) VALUES (
    '支出记录', 3, '个人支出记录', 1, 1, 
    '{"expense_types": ["餐饮", "交通", "购物", "娱乐", "其他"]}', 1, 5
);
```
**结果:** 返回 `record_type_id = 2`

| id   | name     | category_id | description  | has_numeric_values | has_text_values | selection_options                                           | require_photo | max_photos | created_at          |
| ---- | -------- | ----------- | ------------ | ------------------ | --------------- | ----------------------------------------------------------- | ------------- | ---------- | ------------------- |
| 2    | 支出记录 | 3           | 个人支出记录 | 1                  | 1               | {"expense_types": ["餐饮", "交通", "购物", "娱乐", "其他"]} | 1             | 5          | 2026-01-08 08:00:00 |

### 2. 创建数值配置
```sql
INSERT INTO record_value_configs (record_type_id, field_name, field_label, field_type, unit, is_required) VALUES 
(2, 'amount', '金额', 'numeric', '元', 1),
(2, 'category', '类别', 'selection', '', 1);
```
**结果:** 创建2个数值字段配置

| id   | record_type_id | field_name | field_label | field_type | unit | is_required | created_at          |
| ---- | -------------- | ---------- | ----------- | ---------- | ---- | ----------- | ------------------- |
| 1    | 2              | amount     | 金额        | numeric    | 元   | 1           | 2026-01-08 08:00:00 |
| 2    | 2              | category   | 类别        | selection  |      | 1           | 2026-01-08 08:00:00 |

### 3. 创建标签配置
```sql
INSERT INTO tag_config (record_type_id, tag_name, tag_color, is_preset) VALUES 
(2, '餐饮', '#FF6B6B', 1),
(2, '交通', '#4ECDC4', 1);
```
**结果:** 创建2个预设标签

| id   | record_type_id | tag_name | tag_color | is_preset | created_at          |
| ---- | -------------- | -------- | --------- | --------- | ------------------- |
| 1    | 2              | 餐饮     | #FF6B6B   | 1         | 2026-01-08 08:00:00 |
| 2    | 2              | 交通     | #4ECDC4   | 1         | 2026-01-08 08:00:00 |

### 4. 创建主记录
```sql
INSERT INTO records (
    record_type_id, title, content, start_time, status, tags_json
) VALUES (
    2, '午餐支出', '在公司附近吃午餐', '2026-01-08 12:30:00', 'completed', '["餐饮", "午餐"]'
);
```
**结果:** 返回 `record_id = 2`

| id   | record_type_id | title    | content          | start_time          | status    | tags_json       | created_at          |
| ---- | -------------- | -------- | ---------------- | ------------------- | --------- | --------------- | ------------------- |
| 2    | 2              | 午餐支出 | 在公司附近吃午餐 | 2026-01-08 12:30:00 | completed | ["餐饮","午餐"] | 2026-01-08 08:00:00 |

### 5. 创建数值记录
```sql
INSERT INTO record_values (record_id, field_name, field_value, field_text_value, field_type, unit) VALUES 
(2, 'amount', 35.0, NULL, 'numeric', '元'),
(2, 'category', NULL, '餐饮', 'text', NULL);
```
**结果:** 创建2个数值记录

| id   | record_id | field_name | field_value | field_text_value | field_type | unit | created_at          |
| ---- | --------- | ---------- | ----------- | ---------------- | ---------- | ---- | ------------------- |
| 1    | 2         | amount     | 35.0        | null             | numeric    | 元   | 2026-01-08 08:00:00 |
| 2    | 2         | category   | null        | 餐饮             | text       | null | 2026-01-08 08:00:00 |

### 6. 创建照片记录（小票）
```sql
INSERT INTO record_photos (record_id, photo_path, description) VALUES 
(2, '/storage/photos/receipt_20260108_1230.jpg', '午餐小票');
```
**结果:** 创建1张照片记录

| id   | record_id | photo_path                                | description | created_at          |
| ---- | --------- | ----------------------------------------- | ----------- | ------------------- |
| 3    | 2         | /storage/photos/receipt_20260108_1230.jpg | 午餐小票    | 2026-01-08 08:00:00 |

### 7. 查询支出记录详情
```sql
SELECT 
    r.id as record_id,
    r.title,
    r.start_time,
    rv1.field_value as amount,
    rv2.field_text_value as category,
    COUNT(rp.id) as receipt_count
FROM records r
LEFT JOIN record_values rv1 ON r.id = rv1.record_id AND rv1.field_name = 'amount'
LEFT JOIN record_values rv2 ON r.id = rv2.record_id AND rv2.field_name = 'category'
LEFT JOIN record_photos rp ON r.id = rp.record_id
WHERE r.id = 2;
```
**查询结果:**
| record_id | title    | start_time          | amount | category | receipt_count |
| --------- | -------- | ------------------- | ------ | -------- | ------------- |
| 2         | 午餐支出 | 2026-01-08 12:30:00 | 35.0   | 餐饮     | 1             |

### 8. 删除支出记录
```sql
DELETE FROM records WHERE id = 2;
```
**结果:** 删除记录及所有关联数据

---

## 场景3：会议拍照记录流程

### 1. 创建记录类型
```sql
INSERT INTO record_types (
    name, category_id, description, require_photo, max_photos, has_notes
) VALUES (
    '会议拍照', 2, '会议相关拍照记录', 1, 10, 1
);
```
**结果:** 返回 `record_type_id = 3`

| id   | name     | category_id | description      | require_photo | max_photos | has_notes | created_at          |
| ---- | -------- | ----------- | ---------------- | ------------- | ---------- | --------- | ------------------- |
| 3    | 会议拍照 | 2           | 会议相关拍照记录 | 1             | 10         | 1         | 2026-01-08 08:00:00 |

### 2. 创建主记录
```sql
INSERT INTO records (
    record_type_id, title, content, start_time, status
) VALUES (
    3, '周例会拍照', '2026年1月8日周例会', '2026-01-08 10:00:00', 'completed'
);
```
**结果:** 返回 `record_id = 3`

| id   | record_type_id | title      | content            | start_time          | status    | created_at          |
| ---- | -------------- | ---------- | ------------------ | ------------------- | --------- | ------------------- |
| 3    | 3              | 周例会拍照 | 2026年1月8日周例会 | 2026-01-08 10:00:00 | completed | 2026-01-08 08:00:00 |

### 3. 创建多张照片记录
```sql
INSERT INTO record_photos (record_id, photo_path, description, width, height, file_size, sort_order) VALUES 
(3, '/storage/photos/meeting_1.jpg', '会议开始', 1920, 1080, 2048000, 1),
(3, '/storage/photos/meeting_2.jpg', '会议讨论', 1920, 1080, 2150000, 2),
(3, '/storage/photos/meeting_3.jpg', '会议结束', 1920, 1080, 1980000, 3);
```
**结果:** 创建3张照片记录

| id   | record_id | photo_path                    | description | width | height | file_size | sort_order | created_at          |
| ---- | --------- | ----------------------------- | ----------- | ----- | ------ | --------- | ---------- | ------------------- |
| 4    | 3         | /storage/photos/meeting_1.jpg | 会议开始    | 1920  | 1080   | 2048000   | 1          | 2026-01-08 08:00:00 |
| 5    | 3         | /storage/photos/meeting_2.jpg | 会议讨论    | 1920  | 1080   | 2150000   | 2          | 2026-01-08 08:00:00 |
| 6    | 3         | /storage/photos/meeting_3.jpg | 会议结束    | 1920  | 1080   | 1980000   | 3          | 2026-01-08 08:00:00 |

### 4. 查询会议拍照详情
```sql
SELECT 
    r.id as record_id,
    r.title,
    r.start_time,
    r.content,
    COUNT(rp.id) as photo_count,
    GROUP_CONCAT(rp.description, ', ') as photo_descriptions
FROM records r
LEFT JOIN record_photos rp ON r.id = rp.record_id
WHERE r.id = 3
GROUP BY r.id;
```
**查询结果:**
| record_id | title      | start_time          | content            | photo_count | photo_descriptions           |
| --------- | ---------- | ------------------- | ------------------ | ----------- | ---------------------------- |
| 3         | 周例会拍照 | 2026-01-08 10:00:00 | 2026年1月8日周例会 | 3           | 会议开始, 会议讨论, 会议结束 |

### 5. 删除会议拍照记录
```sql
DELETE FROM records WHERE id = 3;
```
**结果:** 删除记录及所有关联照片

---

## 数据库事务操作示例

### 完整的上班打卡事务
```sql
BEGIN TRANSACTION;

-- 创建主记录
INSERT INTO records (
    record_type_id, title, start_time, end_time, duration_seconds, 
    location_name, latitude, longitude, status
) VALUES (
    1, '2026年1月9日上班', 
    '2026-01-09 08:00:00', '2026-01-09 18:30:00', 37800,
    '公司办公室', 39.9042, 116.4074, 'completed'
);

-- 获取刚插入的记录ID
-- 在实际应用中，这里会获取到新插入记录的ID

-- 创建分步记录
INSERT INTO record_steps (record_id, step_name, step_order, step_status, completed_at) VALUES 
(LAST_INSERT_ID(), '出门', 1, 'completed', '2026-01-09 08:00:00'),
(LAST_INSERT_ID(), '上班', 2, 'completed', '2026-01-09 08:30:00'),
(LAST_INSERT_ID(), '下班', 3, 'completed', '2026-01-09 18:00:00'),
(LAST_INSERT_ID(), '到家', 4, 'completed', '2026-01-09 18:30:00');

-- 创建照片记录
INSERT INTO record_photos (record_id, photo_path, description) VALUES 
(LAST_INSERT_ID(), '/storage/photos/checkin_20260109_0830.jpg', '上班打卡照片');

COMMIT;
```